---
subtitle: "Enero 2016 - marzo 2019"
author: Sebastián Garrido de Sierra
header-includes:
  - \usepackage[spanish]{babel}
output: 
  pdf_document:
    latex_engine: lualatex
    fig_caption: true
    toc: true
    toc_depth: 2
    number_sections: false
# mainfont: Helvetica Neue
fontsize: 12pt
urlcolor: blue
---


```{r setup, include=FALSE}
### Paquetes
library(pacman)
p_load(cowplot, extrafont, ggcal, ggrepel, ineq, janitor, lubridate, readxl, rmarkdown, scales, sf, stringi, tidyverse, treemapify, wesanderson, zoo)

### Setup general
Sys.setlocale("LC_ALL", "es_ES.UTF-8") 
options(scipen = 9999)
theme_set(theme_gray())

knitr::opts_chunk$set(echo = TRUE, fig.height = 7, fig.width = 9)
```

```{r prep_titulo, echo = F, warning = F, message = F}
titulo <- 
  datos_delito %>% 
  distinct(categoria_de_delito) %>% 
  mutate(texto = str_c("Análisis de las carpetas de investigación iniciadas por ", str_to_lower(categoria_de_delito), " en la CDMX", sep = ""))
```


---
title: `r titulo$texto`
---


\vspace{4 cm}
**Importante:** Al leer los resultados de este análisis, es necesario tener siempre presente que, de acuerdo con la última edición de la Encuesta Nacional de Victimización y Percepción sobre Seguridad Pública (ENVIPE) del INEGI, en 2017 la cifra negra de delitos^[El INEGI la define como "la razón de los delitos no denunciados más los delitos denunciados sin averiguación previa o carpeta de investigación más aquellos en los cuales no fue especificado si se denunció o si se inició averiguación previa o carpeta de investigación, entre el total de delitos por cien."] de la Ciudad de México fue de **93.4**.^[Ver la hoja 9.5 o 9.6 de [este archivo](https://www.inegi.org.mx/contenidos/programas/envipe/2018/tabulados/IX_ciudad_de_mexico_2018_est.xlsx).] 

Si bien la cifra negra varía por tipo de delito y zona de la ciudad,^[Por ejemplo, mientras la cifra negra del robo total de vehículo es de **42.4**, la de extorsión es de **97**. La variación en la cifra negra es menor en términos geográficos. Oscila entre 91.1 (Región Sur de la CDMX) y 96 (Región Oriente). Ver las hojas 9.5 y 9.6 de [este archivo](https://www.inegi.org.mx/contenidos/programas/envipe/2018/tabulados/IX_ciudad_de_mexico_2018_est.xlsx).] es muy factible que el número de carpetas de investigación incluidas en la base de datos publicada por la ADIP represente un número incompleto del total de delitos cometidos en la Ciudad de México.

\newpage

# Datos generales

```{r prep_datos_lista_delitos, echo = F, warning = F, message = F}
lista_delito <- 
  bd_cdmx %>% 
  filter(categoria_de_delito == id_list[i]) %>% 
  distinct(delito)
```

De acuerdo con datos de la Procuraduría General de Justicia de la Ciudad de México (PGJCDMX), publicados por la [Agencia Digital de Innovación Pública](https://datos.cdmx.gob.mx/explore/dataset/carpetas-de-investigacion-pgj-cdmx/custom/) (ADIP), entre el 1 de enero de 2016 y el `r datos_delito %>% filter(fecha_inicio == max(fecha_inicio)) %>% summarise(fecha = last(fecha_texto))` se iniciaron **`r datos_delito %>% summarise(num = comma(n()))`**^[Esta cifra solamente incluye las carpetas de investigación en las que se reporta que el delito ocurrió en alguna de las 16 alcaldías de la CDMX. Por este motivo, las cifras aquí reportadas pueden ser menores que las publicadas en el [portal](https://datos.cdmx.gob.mx/explore/dataset/carpetas-de-investigacion-pgj-cdmx/custom/) de la ADIP.] carpetas de investigación por delitos agrupados dentro de la categoría de **`r datos_delito %>% summarise(delito = str_to_lower(last(categoria_de_delito)))`**.^[La lista completa de delitos en esta categoría incluye `r stri_replace_last(str_c(str_to_lower(sort(lista_delito$delito)), collapse = ", "), replacement = " y", regex = ",")`.]

```{r prep_carpetas_iniciadas_por_dia, warning = F, message = F, echo = F}
ranking_carpetas_por_dia <- 
  datos_delito %>%
  count(dia_semana_texto) %>% 
  filter(!is.na(dia_semana_texto)) %>% 
  mutate(ranking_dias = rank(-n, ties.method = "first"), 
         dia_semana_completo = case_when(dia_semana_texto == "Lun" ~ "lunes",
                                         dia_semana_texto == "Mar" ~ "martes",
                                         dia_semana_texto == "Mié" ~ "miércoles",
                                         dia_semana_texto == "Jue" ~ "jueves",
                                         dia_semana_texto == "Vie" ~ "viernes",
                                         dia_semana_texto == "Sáb" ~ "sábado",
                                         dia_semana_texto == "Dom" ~ "domingo"))
```


Como muestra la siguiente gráfica, durante el período analizado el **`r ranking_carpetas_por_dia %>% filter(ranking_dias == 1) %>% select(dia_semana_completo)`** fue el día de la semana en el que se iniciaron el mayor número de carpetas de investigación relacionadas con esta categoría de delito (**`r ranking_carpetas_por_dia %>% filter(ranking_dias == 1) %>% mutate(n = comma(n)) %>%  select(n)`**). El **`r stri_replace_last(str_c(ranking_carpetas_por_dia$dia_semana_completo[ranking_carpetas_por_dia$ranking_dias%in% c(2, 3)], collapse = ", "), replacement = " y", regex = ",")`** fueron el segundo y tercer día de la semana en el que se iniciaron más carpetas de investigación por algún delito agrupado en la categoría de `r datos_delito %>% summarise(delito = str_to_lower(last(categoria_de_delito)))` (**`r ranking_carpetas_por_dia %>% filter(ranking_dias == 2) %>% mutate(n = comma(n)) %>%  select(n)`** y **`r ranking_carpetas_por_dia %>% filter(ranking_dias == 3) %>% mutate(n = comma(n)) %>%  select(n)`**, respectivamente).

\vspace{2 mm}

```{r g_frecuencia_carpetas_iniciadas_por_dia, warning = F, message = F, echo = F, fig.height = 6}
datos_delito %>%
  count(dia_semana) %>% 
  filter(!is.na(dia_semana)) %>% 
  ggplot(aes(dia_semana, n)) +
  geom_col(fill = "#a50300") +
  geom_text(aes(label = comma(n)), color = "white", vjust = 1.5, fontface = "bold") +
  scale_x_continuous(breaks = 1:7, labels = c("Lun", "Mar", "Mié", "Jue", "Vie", "Sáb", "Dom")) +
  scale_y_continuous(labels = comma) +
  labs(title = str_wrap(str_to_upper(str_c("número de carpetas de investigación por ", id_list[i], " iniciadas en cada día de la semana", sep = "")), width = 60),
       subtitle = "Datos de enero de 2016 al 31 de marzo de 2019",
       x = NULL,
       y = NULL) +
  tema +
  theme(axis.text.y = element_blank(), 
        panel.grid = element_blank())
```



\newpage

# Evolución en el tiempo - CDMX

```{r prep_datos_cambio, warning = F, message = F, echo = F}
cambio_19_vs_previos <- 
  datos_delito %>% 
  filter(mes %in% c("Enero", "Febrero", "Marzo")) %>% 
  group_by(ano) %>% 
  summarise(num = n()) %>% 
  ungroup() %>%  
  mutate(cambio_vs_2018 = round((((num - lag(num))/lag(num))*100), 1), 
         cambio_vs_2017 = round(((num - lag(num, n = 2))/lag(num, n = 2))*100, 1), 
         cambio_vs_2016 = round(((num - lag(num, n = 3))/lag(num, n = 3))*100, 1),
         sentido_19_vs_18 = ifelse(cambio_vs_2018 > 0, "mayor", "menor"),
         sentido_19_vs_17 = ifelse(cambio_vs_2017 > 0, "más grande", "más pequeña"),
         sentido_19_vs_16 = ifelse(cambio_vs_2016 > 0, "mayor", "menor"), 
         cambio_vs_2018 = abs(cambio_vs_2018),
         cambio_vs_2017 = abs(cambio_vs_2017),
         cambio_vs_2016 = abs(cambio_vs_2016),
         num = comma(num))  

cambio_2019_vs_2018 <- 
  datos_delito %>% 
  filter(ano %in% c(2018, 2019)) %>% 
  group_by(ano) %>% 
  summarise(num = n()) %>% 
  mutate(dias_transcurridos = as.numeric(as_date("2019-03-31") - as_date("2019-01-01")),
         proyeccion = ifelse(ano == 2018, num, (num/dias_transcurridos)*365), 
         cambio_19_18 = round((proyeccion - lag(proyeccion))/lag(proyeccion)*100, 1),
         proyeccion = comma(proyeccion), 
         sentido = ifelse(cambio_19_18 > 0, "mayor", "menor"),
         cambio_19_18 = abs(cambio_19_18))
```

En los primeros tres meses de 2019 se han acumulado **`r datos_delito %>% filter(ano == 2019) %>% summarise(num = comma(n()))`** carpetas de investigación por este delito en la CDMX. Esta cifra es **`r cambio_19_vs_previos %>% filter(ano == 2019) %>% select(cambio_vs_2018)`%** `r cambio_19_vs_previos %>% filter(ano == 2019) %>% select(sentido_19_vs_18)` que el número de carpetas acumulado hasta marzo de 2018 (`r cambio_19_vs_previos %>% filter(ano == 2018) %>% select(num)`), **`r cambio_19_vs_previos %>% filter(ano == 2019) %>% select(cambio_vs_2017)`%** `r cambio_19_vs_previos %>% filter(ano == 2019) %>% select(sentido_19_vs_17)` que en el mismo período durante 2017 (`r cambio_19_vs_previos %>% filter(ano == 2017) %>% select(num)`) y  **`r cambio_19_vs_previos %>% filter(ano == 2019) %>% select(cambio_vs_2016)`%** `r cambio_19_vs_previos %>% filter(ano == 2019) %>% select(sentido_19_vs_16)` que en 2016 (`r cambio_19_vs_previos %>% filter(ano == 2016) %>% select(num)`). 




\vspace{2 mm}

```{r g_carpetas_acumuladas_x_dia, echo = F, dpi = 200}
datos_delito %>% 
  arrange(fecha_inicio) %>% 
  group_by(ano) %>% 
  mutate(dia_ano = yday(fecha_inicio)) %>% 
  ungroup() %>% 
  group_by(ano, dia_ano) %>% 
  summarise(num_carpetas_diarias = n()) %>% 
  ungroup() %>% 
  group_by(ano) %>% 
  mutate(num_acumulado_carpetas = cumsum(num_carpetas_diarias), 
         etiqueta = ifelse(dia_ano == max(dia_ano), ano, ""),
         color_linea = ifelse(ano == 2019, "sí", "no")) %>%
  ungroup() %>%
  ggplot(aes(dia_ano, num_acumulado_carpetas, group = ano, color = color_linea)) +
  geom_line(size = 1) +
  geom_text_repel(aes(label = etiqueta), hjust = -0.15, color = "grey40", fontface = "bold", size = 5) +
  scale_x_continuous(breaks = c(1, seq(30, 360, 30)), limits = c(0, 380)) +
  scale_y_continuous(label = comma) +
  scale_color_manual(values = c("grey70", "#a50300")) +
  labs(title = str_wrap(str_to_upper(str_c("número de carpetas de investigación por ", unique(datos_delito$categoria_de_delito), ", acumulado diariamente en la ciudad de méxico", paste = "")), width = 55),
       subtitle = "Datos de enero de 2016 al 31 de marzo de 2019",
       x = "\nDías del año transcurridos",
       y = "Número de carpetas de investigación\n", 
       caption = "\nFuente: Agencia Digital de Innovación Pública de la CDMX con datos de la PGJ de la Ciudad de México.") +
  tema +
  theme(legend.position = "none")
```

\vspace{2 mm}

```{r prep_tasa_mensual_anaualizada_carpetas, warning = F, message = F, echo = F}
scaleFUN <- function(x) sprintf("%.2f", x)

tasa_mensual_anualizada <- 
  datos_delito %>% 
  arrange(fecha_inicio) %>% 
  mutate(fecha_techo_mes = ceiling_date(fecha_inicio, unit = "month") - 1) %>% 
  select(fecha_inicio, fecha_techo_mes) %>% 
  group_by(fecha_techo_mes) %>% 
  summarise(num_ci = n()) %>% 
  ungroup() %>% 
  mutate(año = year(fecha_techo_mes), 
         mes = month(fecha_techo_mes)) %>% 
  left_join(datos_poblacion_cdmx, by = c("año" = "ano")) %>% 
  mutate(tasa_x_100k = (num_ci/pob_tot)*100000*12) %>% 
  select(fecha_techo_mes, año, mes, everything()) %>% 
  mutate(color_linea = ifelse(año == 2019, "sí", "no")) %>%
  group_by(año) %>% 
  mutate(etiqueta = ifelse(fecha_techo_mes == max(fecha_techo_mes), año, "")) %>% 
  ungroup() 

meses_top_rank_tasa <- 
  tasa_mensual_anualizada %>% 
  mutate(rank_tasa = rank(-tasa_x_100k, ties.method = "first")) %>% 
  select(fecha_techo_mes, año, tasa_x_100k, rank_tasa) %>% 
  summarise(meses_top_rank_tasa = sum(fecha_techo_mes >= as_datetime("2018-12-31 23:59:59") & rank_tasa < 6)) %>%
  mutate(meses_top_rank_tasa = case_when(meses_top_rank_tasa == 0 ~ "**ninguno** de los cuatro meses de la actual administración están",
                                         meses_top_rank_tasa == 1 ~ "**uno** de los cuatro meses de la actual administración están", 
                                         meses_top_rank_tasa == 2 ~ "**dos** de los cuatro meses de la actual administración están", 
                                         meses_top_rank_tasa == 3 ~ "**tres** de los cuatro meses de la actual administración están", 
                                         meses_top_rank_tasa == 4 ~ "los **cuatro** meses de la actual administración están")) %>% 
  pull()
```


La siguiente gráfica muestra la evolución de la **tasa mensual anualizada** de carpetas de investigación por `r str_to_lower(unique(datos_delito$categoria_de_delito))`.^[Las tasas fueron calculadas usando proyecciones poblacionales de CONAPO para la Ciudad de México (ver [archivo](http://www.conapo.gob.mx/work/models/CONAPO/Datos_Abiertos/Proyecciones2018/pob_mit_proyecciones.csv)). Con el fin de anualizar la tasa mensual, (i) dividimos el número de carpetas de investigación mensual entre la población del año correspondiente; (ii) multiplicamos el resultado por 100 mil; y (iii) por último multiplicamos el resultado por 12.] De acuerdo con estos datos, `r meses_top_rank_tasa` entre los cinco meses con la mayor tasa de carpetas de investigación de todo el período analizado (**39** meses en total). 


\vspace{2 mm}

```{r g_tasa_mensual_anaualizada_carpetas, echo = F, dpi = 200}
tasa_mensual_anualizada %>% 
  ggplot(aes(x = mes, y = tasa_x_100k, group = año, color = color_linea)) +
  geom_line(size = 1) +
  geom_text_repel(aes(label = etiqueta), hjust = -0.15, color = "grey40", fontface = "bold", size = 5) +
  scale_x_continuous(limits = c(1, 12.5), breaks = 1:12, labels = c("Ene", "Feb", "Mar", "Abr", "May", "Jun", "Jul", "Ago", "Sep", "Oct", "Nov", "Dic")) +
  # scale_y_continuous(label = comma) +
  scale_color_manual(values = c("grey70", "#a50300")) +
  labs(title = str_wrap(str_to_upper(str_c("tasa mensual anualizada de carpetas de investigación por ", unique(datos_delito$categoria_de_delito), ", en la ciudad de méxico", paste = "")), width = 60),
       subtitle = "Tasa por cada 100 mil habitantes",
       x = "\n",
       y = "Tasa mensual anualizada\n", 
       caption = "\nFuente: Agencia Digital de Innovación Pública de la CDMX con datos de la PGJ de la Ciudad de México y proyecciones poblacionales de CONAPO.") +
  tema +
  theme(legend.position = "none")

```


```{r prep_tasa_trimestral_anaualizada_carpetas, warning = F, message = F, echo = F}
scaleFUN <- function(x) sprintf("%.2f", x)

tasa_trimestral_anualizada <- 
  datos_delito %>% 
  filter(mes %in% c("Enero", "Febrero", "Marzo")) %>% 
  group_by(ano) %>% 
  summarise(num_ci = n()) %>% 
  ungroup() %>% 
  left_join(datos_poblacion_cdmx, by = c("ano" = "ano")) %>%   
  mutate(tasa_x_100k = (num_ci/pob_tot)*100000*4)

incremento_tasa_trimestral <- 
  tasa_trimestral_anualizada %>% 
  mutate(cambio_por_tasa_19_18 = round(((tasa_x_100k - lag(tasa_x_100k))/lag(tasa_x_100k))*100, 1),
         cambio_por_tasa_19_17 = round(((tasa_x_100k - lag(tasa_x_100k, n = 2))/lag(tasa_x_100k, n = 2))*100, 1),
         cambio_por_tasa_19_16 = round(((tasa_x_100k - lag(tasa_x_100k, n = 3))/lag(tasa_x_100k, n = 3))*100, 1),
         sentido_19_18 = (ifelse(cambio_por_tasa_19_18 > 0, "mayor que", "menor que")),
         sentido_19_17 = (ifelse(cambio_por_tasa_19_17 > 0, "más grande que", "menor que")),
         sentido_19_16 = (ifelse(cambio_por_tasa_19_16 > 0, "mayor que", "menor que")),
         cambio_por_tasa_19_18 = str_c("**", abs(cambio_por_tasa_19_18), "%** ", sentido_19_18, sep = ""),
         cambio_por_tasa_19_17 = str_c("**", abs(cambio_por_tasa_19_17), "%** ", sentido_19_17, sep = ""),
         cambio_por_tasa_19_16 = str_c("**", abs(cambio_por_tasa_19_16), "%** ", sentido_19_16, sep = "")) %>% 
  select(-starts_with("sentido"))
```

\vspace{2 mm}

De forma complementaria a los datos recién presentados, la gráfica a continuación muestra la **tasa trimestral anualizada** de carpetas de investigación por `r str_to_lower(unique(datos_delito$categoria_de_delito))`, para el período enero-marzo de los cuatro años disponible.^[Las tasas fueron calculadas usando proyecciones poblacionales de CONAPO para la Ciudad de México (ver [archivo](http://www.conapo.gob.mx/work/models/CONAPO/Datos_Abiertos/Proyecciones2018/pob_mit_proyecciones.csv)). Con el fin de anualizar la tasa trimestral, (i) dividimos el número de carpetas de investigación acumuladas en el primer trimestre del año correspondiente, entre la población del año respectivo; (ii) multiplicamos el resultado por 100 mil; y (iii) por último multiplicamos el resultado por cuatro.] 

Estas cifras revelan que la tasa trimestral anualizada de 2019 es `r incremento_tasa_trimestral %>% filter(ano == 2019) %>% select(cambio_por_tasa_19_18)` la tasa para el mismo período en 2018, `r incremento_tasa_trimestral %>% filter(ano == 2019) %>% select(cambio_por_tasa_19_17)` en 2017 y `r incremento_tasa_trimestral %>% filter(ano == 2019) %>% select(cambio_por_tasa_19_16)` en 2016.

\vspace{2 mm}


```{r g_tasa_trimestral_anaualizada_carpetas, echo = F, dpi = 200, fig.height = 6}
tasa_trimestral_anualizada %>% 
  ggplot(aes(x = ano, y = tasa_x_100k)) +
  geom_col(fill = "#a50300") +
  geom_text(aes(label = round(tasa_x_100k, 2)), color = "white", vjust = 1.5, fontface = "bold", size = 5)  +
  scale_x_continuous(breaks = 2016:2019, labels = c("Ene. - mar. \'16", "Ene. - mar. \'17", "Ene. - mar. \'18", "Ene. - mar. \'19")) +
  scale_y_continuous(labels = comma, expand = c(0, 0)) +
  labs(title = str_wrap(str_to_upper(str_c("tasa trimestral anualizada de carpetas de investigación por ", id_list[i], ", en la ciudad de méxico", sep = "")), width = 60),
       subtitle = "Tasa por cada 100 mil habitantes",
       x = NULL,
       y = NULL,
       caption = "\nFuente: Agencia Digital de Innovación Pública de la CDMX con datos de la PGJ de la Ciudad de México y proyecciones poblacionales de CONAPO.") +
  tema +
  theme(axis.text.y = element_blank(), 
        panel.grid = element_blank())
```



\newpage

# Evolución en el tiempo - Alcaldías

```{r prep_datos_carpetas_acumuladas_x_trimestre_alcaldia, echo = F, cache = T, echo = F, warning = F, message = F}
### Construir data frame con el promedio de carpetas de investigación acumuladas diariamente por tipo de delito y alcaldía, para 2018 y 2019
cambio_num_acumulado_delitos_alcaldia <- 
  datos_delito %>% 
  filter(ano %in% c(2018, 2019), 
         mes %in% c("Enero", "Febrero", "Marzo")) %>% 
  group_by(ano, alcaldia) %>% 
  summarise(num_acumulado_carpetas = n(), 
            categoria_de_delito = last(categoria_de_delito)) %>% 
  ungroup() %>% 
  select(ano, alcaldia, num_acumulado_carpetas, categoria_de_delito) %>% 
  complete(alcaldia, nesting(ano)) %>% # Completar renglones que faltan en algunas alcadías porque no hubo carpeta en el año correspondiente
  mutate(num_acumulado_carpetas = ifelse(is.na(num_acumulado_carpetas), # Reemplazar NAs de num_acumulado_carpetas por 0
                                         0, num_acumulado_carpetas),
         etiqueta_alcaldia = ifelse(ano == 2019, alcaldia, "")) %>%  # Generar etiquetas para gráfica
  arrange(alcaldia, ano) %>% 
  group_by(alcaldia) %>% 
  mutate(cambio = num_acumulado_carpetas - lag(num_acumulado_carpetas), # Cambio absoluto
         color_geoms = ifelse(num_acumulado_carpetas > lag(num_acumulado_carpetas), # Generar variable para color de geoms
                              "rojo", "verde"),
         color_geoms = na.locf(color_geoms)) %>% # Llenar NAs de color_geoms
  ungroup()

### Construir data frame con datos sobre el cambio en el número acumulado de carpetas de investigación por tipo de delito y alcaldía 

datos_cambio_alcaldias <- 
  cambio_num_acumulado_delitos_alcaldia %>% 
  arrange(alcaldia, ano) %>% 
  group_by(alcaldia) %>% 
  mutate(incremento = ifelse(cambio >= 0, 1, 0)) %>% 
  ungroup()  %>% 
  summarise(num_alcaldias = n()/2,
            num_alcaldias_incremento = sum(incremento, na.rm = T))

```


De las **`r datos_cambio_alcaldias$num_alcaldias`** alcaldías en las que se inició al menos una carpeta de investigación por **`r datos_delito %>% summarise(delito = str_to_lower(last(categoria_de_delito)))`** en el primer trimestre de 2018 y 2019, en **`r datos_cambio_alcaldias$num_alcaldias_incremento`** aumentó el número acumulado de carpetas por este delito en los primeros tres meses de este año.

\vspace{2 mm}

```{r g_carpetas_acumuladas_x_trimestre_alcaldia, echo = F, dpi = 200, fig.height = 8}
cambio_num_acumulado_delitos_alcaldia %>% 
  ggplot(aes(x = ano, y = num_acumulado_carpetas, group = alcaldia,  color = color_geoms)) +
  geom_line(size = 1, alpha = 0.8) +
  geom_point(size = 3, alpha = 0.8) +
  geom_text_repel(aes(label = str_wrap(etiqueta_alcaldia, width = 15)), nudge_x = 2, color = "grey20", segment.color = "grey80", size = 3) +
  scale_x_continuous(breaks = c(2018, 2019), labels = c("Ene. - mar. \'18\n", "Ene. - mar. \'19\n"), 
                     limits = c(2018, 2019.05)) +
  scale_color_manual(values = c("tomato", "#66bd63")) +
  labs(title = str_wrap(str_to_upper(str_c("número acumulado de carpetas de investigación por ", unique(datos_delito$categoria_de_delito), ", primer trimestre de 2019 vs. primer trimestre de 2018, por alcaldía", sep = "")), width = 57),
       subtitle = str_wrap("La gráfica muestra el cambio en el número de carpetas de investigación acumuladas en el primer trimestre de cada año", width = 95),
       x = NULL,
       y = "Número acumulado de\ncarpetas de investigación\n",
       caption = "\nFuente: Agencia Digital de Innovación Pública de la CDMX con datos de la PGJ de la Ciudad de México.") +
  tema +
  theme(panel.grid.major.x = element_blank(),
        legend.position = "none")
```

\vspace{2 mm}

```{r prep_datos_texto_ranking_cambio_alcaldias, echo = F, cache = T, echo = F, warning = F, message = F}
datos_ranking_cambio_alcaldias <- 
  cambio_num_acumulado_delitos_alcaldia %>% 
  filter(!is.na(cambio)) %>% 
  mutate(ranking_cambio = rank(-cambio, ties.method = "first")) %>% 
  arrange(ranking_cambio)

top_3_cambio <- 
  datos_ranking_cambio_alcaldias %>% 
  top_n(-3) %>% 
  select(alcaldia)

bottom_3_cambio <- 
  datos_ranking_cambio_alcaldias %>% 
  top_n(3) %>% 
  select(alcaldia)

```



Como muestra la gráfica que se presenta a continuación, las tres alcaldías con el mayor incremento en el número de carpetas de investigación por `r datos_delito %>% summarise(delito = str_to_lower(last(categoria_de_delito)))` en el arranque de 2019 vs. el mismo período en 2018 son `r stri_replace_last(str_c(top_3_cambio$alcaldia, collapse = ", "), replacement = " y", regex = ",")  `. 

\vspace{2 mm}

```{r g_cambio_abs_carpetas_acumuladas_x_trimestre_alcaldia, echo = F, dpi = 200, warning = F}
cambio_num_acumulado_delitos_alcaldia %>% 
  filter(!is.na(cambio)) %>% 
  mutate(etiqueta_cambio_positivo_grande = ifelse(cambio > 2, paste("+", comma(round(cambio, 1)), sep = ""), ""),
         etiqueta_cambio_positivo_pequenio = ifelse(cambio >= 0 & cambio < 2, paste("+", comma(round(cambio, 1)), sep = ""), ""),
         etiqueta_cambio_negativo_grande = ifelse(cambio < -2, comma(round(cambio, 1)), ""),
         etiqueta_cambio_negativo_pequenio = ifelse(cambio <= 0 & cambio > -2, comma(round(cambio, 1)), "")) %>% 
  ggplot(aes(fct_reorder(alcaldia, cambio), cambio, fill = color_geoms)) +
  geom_col(alpha = 0.9) +
  geom_text(aes(label = etiqueta_cambio_positivo_grande), hjust = 1.2, color = "white", fontface = "bold", size = 4) +
  geom_text(aes(label = etiqueta_cambio_positivo_pequenio), hjust = -0.4, color = "grey30", fontface = "bold", size = 4) +
  geom_text(aes(label = etiqueta_cambio_negativo_grande), hjust = -0.6, color = "white", fontface = "bold", size = 4) +
  geom_text(aes(label = etiqueta_cambio_negativo_pequenio), hjust = 1.2, color = "grey30", fontface = "bold", size = 4) +
  coord_flip() +
  scale_y_continuous(breaks = c(min(cambio_num_acumulado_delitos_alcaldia$cambio, na.rm = T), max(cambio_num_acumulado_delitos_alcaldia$cambio, na.rm = T)),
                     labels = c("Mejor", "Peor")) +
  scale_fill_manual(values = c("tomato", "#66bd63")) +
  labs(title = str_wrap(str_to_upper(str_c("cambio en el número acumulado de carpetas de investigación por ", unique(datos_delito$categoria_de_delito), ", primer trimestre de 2019 vs. primer trimestre de 2018, por alcaldía", sep = "")), width = 50),
       subtitle = str_wrap("La gráfica muestra el cambio absoluto en el número de carpetas de investigación acumuladas en el primer trimestre de cada año", width = 85),
       x = NULL,
       y = "\nCambio en el número de carpetas de investigación\n",
       caption = "\nFuente: Agencia Digital de Innovación Pública de la CDMX con datos de la PGJ de la Ciudad de México.") +
  tema +
  theme(panel.grid.major.x = element_blank(),
        legend.position = "none",
        axis.title.x = element_blank(),
        axis.text.x = element_text(face = "bold", size = 15))

```


\vspace{2 mm}

```{r prep_datos_trimestral_anualizada_por_alcaldia, echo = F, cache = T, echo = F, warning = F, message = F}
### Tasa trimestral anualizada por alcaldía para 2018 y 2019
tasa_trimestral_anualizada_alcaldia <- 
  datos_delito %>% 
  filter(ano %in% c(2018, 2019), 
         mes %in% c("Enero", "Febrero", "Marzo")) %>% 
  group_by(ano, alcaldia) %>% 
  summarise(num_ci = n()) %>% 
  ungroup() %>% 
  left_join(datos_poblacion_alcaldias, by = "alcaldia") %>% 
  mutate(tasa_x_100k = (num_ci/pob_total)*100000*4) %>% 
  arrange(alcaldia, ano) %>% 
  complete(alcaldia, nesting(ano)) %>% # Completar renglones que faltan en algunas alcadías porque no hubo carpeta en el año correspondiente
  mutate(tasa_x_100k = ifelse(is.na(tasa_x_100k), # Reemplazar NAs de tasa_x_100k por 0
                                         0, tasa_x_100k),
         etiqueta_alcaldia = ifelse(ano == 2019, alcaldia, "")) %>%  # Generar etiquetas para gráfica
  group_by(alcaldia) %>% 
  mutate(color_geoms = ifelse(tasa_x_100k > lag(tasa_x_100k), # Generar variable para color de geoms
                              "rojo", "verde"),
         color_geoms = na.locf(color_geoms)) %>% # Llenar NAs de color_geoms
  ungroup()

# Calculo del número de alcaldías para las cuales aumento la tasa trimestral anualizada
datos_cambio_alcaldias_tasa <- 
  tasa_trimestral_anualizada_alcaldia %>% 
  group_by(alcaldia) %>% 
  mutate(cambio = tasa_x_100k - lag(tasa_x_100k),
         incremento = ifelse(cambio >= 0, 1, 0)) %>% 
  ungroup() %>%
  summarise(num_alcaldias = n()/2,
            num_alcaldias_incremento = sum(incremento, na.rm = T))


# Top-3 alcaldías con mayores tasas en el primer trimestre de 2019
top_3_tasa_alcaldia <- 
  tasa_trimestral_anualizada_alcaldia %>%  
  filter(ano == 2019) %>% 
  mutate(ranking_tasa = rank(-tasa_x_100k, ties.method = "first")) %>% 
  arrange(ranking_tasa) %>% 
  top_n(-3) %>% 
  mutate(tasa_x_100k = str_c("**", round(tasa_x_100k, 1), "**", sep = ""))

# Top-3 alcaldías con mayor cambio en la tasa del 1T de 2019 vs. 1T de 2018
top_3_cambio_tasa_alcaldia <- 
  tasa_trimestral_anualizada_alcaldia %>%
  group_by(alcaldia) %>% 
  mutate(cambio_por_tasa = round(((tasa_x_100k - lag(tasa_x_100k))/lag(tasa_x_100k))*100, 1)) %>% 
  ungroup() %>% 
  select(alcaldia, ano, tasa_x_100k, cambio_por_tasa) %>% 
  filter(ano == 2019) %>%
  mutate(ranking_cambio_tasa = rank(-cambio_por_tasa, ties.method = "first")) %>% 
  arrange(ranking_cambio_tasa) %>% 
  top_n(-3) %>% 
  select(alcaldia, cambio_por_tasa)


# Top-3 alcaldías con mayor reducción en la tasa del 1T de 2019 vs. 1T de 2018
bottom_3_cambio_tasa_alcaldia <- 
  tasa_trimestral_anualizada_alcaldia %>%
  group_by(alcaldia) %>% 
  mutate(cambio_por_tasa = round(((tasa_x_100k - lag(tasa_x_100k))/lag(tasa_x_100k))*100, 1)) %>% 
  ungroup() %>% 
  select(alcaldia, ano, tasa_x_100k, cambio_por_tasa) %>% 
  filter(ano == 2019) %>%
  mutate(ranking_cambio_tasa = rank(-cambio_por_tasa, ties.method = "first")) %>% 
  arrange(-ranking_cambio_tasa) %>% 
  top_n(3) %>% 
  select(alcaldia, cambio_por_tasa)
```


La siguiente gráfica ofrece una perspectiva similar a la de las dos anteriores, pero ahora mostrando el cambio de la tasa trimestral anualizada^[Las tasas fueron calculadas usando estimaciones de CONAPO para cada alcaldía para 2017, reportadas por el INEGI y la CDMX en el [Anuario estadístico y geográfico de la Ciudad de México 2017](https://bit.ly/2Oya7eh). Con el fin de anualizar la tasa trimestral, (i) dividimos el número de carpetas de investigación acumuladas en el primer trimestre del año correspondiente en cada alcaldía, entre la población de dicha alcaldía en 2017; (ii) multiplicamos el resultado por 100 mil; y (iii) por último multiplicamos el resultado por cuatro.] de carpetas de investigación por `r datos_delito %>% summarise(delito = str_to_lower(last(categoria_de_delito)))` para el período enero-marzo de 2018 vs. el mismo plazo en 2019. 

De forma consecuente con lo antes mencionado, la gráfica muestra que la tasa aumentó en **`r datos_cambio_alcaldias_tasa$num_alcaldias_incremento`** de las **`r datos_cambio_alcaldias_tasa$num_alcaldias`** alcaldías en las que se abrió al menos una carpeta de investigación por **`r datos_delito %>% summarise(delito = str_to_lower(last(categoria_de_delito)))`** en el primer trimestre de 2018 y 2019.

La gráfica ilustra también que las **tres** alcaldías con las mayores tasas en el primer trimestre de 2019 son `r stri_replace_last(str_c(top_3_tasa_alcaldia$alcaldia, collapse = ", "), replacement = " y", regex = ",")`, con valores de `r stri_replace_last(str_c(top_3_tasa_alcaldia$tasa_x_100k, collapse = ", "), replacement = " y", regex = ",")`, respectivamente. Las tres alcaldías con el mayor incremento interanual en la tasa del primer trimestre son `r stri_replace_last(str_c(top_3_cambio_tasa_alcaldia$alcaldia, collapse = ", "), replacement = " y", regex = ",")`, y las tres con la mayor reducción son `r stri_replace_last(str_c(bottom_3_cambio_tasa_alcaldia$alcaldia, collapse = ", "), replacement = " y", regex = ",")`.


```{r g_tasa_trimestral_anualizada_por_alcaldia, echo = F, dpi = 200, fig.height = 8}
tasa_trimestral_anualizada_alcaldia %>% 
  ggplot(aes(x = ano, y = tasa_x_100k, 
             group = alcaldia,  
             color = color_geoms)) +
  geom_line(size = 1, alpha = 0.8) +
  geom_point(size = 3, alpha = 0.8) +
  geom_text_repel(aes(label = str_wrap(etiqueta_alcaldia, width = 15)), nudge_x = 2, color = "grey20", segment.color = "grey80", size = 3) +
  scale_x_continuous(breaks = c(2018, 2019), labels = c("Ene. - mar. \'18\n", "Ene. - mar. \'19\n"), 
                     limits = c(2018, 2019.05)) +
  scale_color_manual(values = c("tomato", "#66bd63")) +
  labs(title = str_wrap(str_to_upper(str_c("tasa trimestral anualizada de carpetas de investigación por ", unique(datos_delito$categoria_de_delito), ", primer trimestre de 2019 vs. primer trimestre de 2018, por alcaldía", sep = "")), width = 57),
       subtitle = "Tasa por cada 100 mil habitantes",
       x = NULL,
       y = "Tasa trimestral anualizada\n",
       caption = "\nFuente: Agencia Digital de Innovación Pública de la CDMX con datos de la PGJ de la Ciudad de México y el Anuario estadístico y geográfico de la\nCiudad de México 2017 del INEGI y la CDMX.") +
  tema +
  theme(panel.grid.major.x = element_blank(),
        legend.position = "none")
```

\vspace{2 mm}




\newpage 

# Distribución geográfica - Alcaldías



```{r prep_datos_concentracion_porcentual_carpetas_por_alcaldia, echo = F, cache = T, echo = F, warning = F, message = F}
datos_concentracion_porcentual_carpetas_por_alcaldia <- 
  bd_cdmx %>% 
  group_by(alcaldia, categoria_de_delito) %>% 
  summarise(num = n()) %>% 
  ungroup() %>% 
  group_by(categoria_de_delito) %>% 
  mutate(total = sum(num), 
         por = round((num/sum(num))*100, 1), 
         rank_del = rank(-por)) %>% 
  ungroup() %>% 
  arrange(rank_del, -por) %>% 
  filter(rank_del == 1) %>% 
  mutate(rank_concentracion = rank(-por), 
         rank_concentracion_texto = case_when(rank_concentracion == 1 ~"primera",
                                       rank_concentracion == 2 ~"segunda",
                                       rank_concentracion == 3 ~"tercera",
                                       rank_concentracion == 4 ~"cuarta",
                                       rank_concentracion == 5 ~"quinta",
                                       rank_concentracion == 6 ~"sexta",
                                       rank_concentracion == 7 ~"septima",
                                       rank_concentracion == 8 ~"octava",
                                       rank_concentracion == 9 ~"novena",
                                       rank_concentracion == 10 ~"decima",
                                       rank_concentracion == 11 ~"onceava",
                                       rank_concentracion == 12 ~"doceava",
                                       rank_concentracion == 13 ~"decimo tercera",
                                       rank_concentracion == 14 ~"decimo cuarta",
                                       rank_concentracion == 15 ~"decimo quinta",
                                       rank_concentracion == 16 ~"decimo sexta"),
         color_geom = ifelse(categoria_de_delito == id_list[i], "a", "b"))  
```


De acuerdo con los datos publicados por la ADIP, en el período que va del 1 de enero de 2016 al 31 de marzo de 2019 `r datos_delito %>% summarise(delito = str_to_lower(last(categoria_de_delito)))` es la **`r datos_concentracion_porcentual_carpetas_por_alcaldia %>% filter(categoria_de_delito == id_list[i]) %>% select(rank_concentracion_texto)`** categoría de delito con mayor concentración geográfica a nivel alcaldía con respecto a otros delitos. El **`r datos_concentracion_porcentual_carpetas_por_alcaldia %>% filter(categoria_de_delito == id_list[i]) %>% select(por)` %** de las carpetas de investigación iniciadas entre el 1 de enero de 2016 y el 31 de marzo de este año son por hechos ocurridos en `r datos_concentracion_porcentual_carpetas_por_alcaldia %>% filter(categoria_de_delito == id_list[i]) %>% select(alcaldia)`.

\vspace{2 mm}

```{r g_concentracion_porcentual_carpetas_por_alcaldia, echo = F, dpi = 200, warning = F, fig.height = 10}
datos_concentracion_porcentual_carpetas_por_alcaldia %>% 
  ggplot(aes(x = fct_reorder(str_wrap(categoria_de_delito, width = 30), por), y = por, fill = color_geom)) +
  geom_col(alpha = 0.9) +
  geom_text(aes(label = str_c(alcaldia, " (", round(por, 1), "%)", sep = "")), hjust = 1.05, color = "white", fontface = "bold", size = 3.5) +
  coord_flip() +
  scale_y_continuous(expand = c(0, 0)) +
  scale_fill_manual(values = c("#a50300", "grey70")) +
  labs(title = str_wrap(str_to_upper("concentración geográfica de las carpetas de investigación iniciadas por cada categoría de delito"), width = 50),
       subtitle = str_wrap("Carpetas de investigación acumuladas entre el 1 enero de 2016 y el 31 de marzo de 2019", width = 75),
       x = NULL,
       y = "Porcentaje del total, por categoría de delito",
       caption = "\nFuente: Agencia Digital de Innovación Pública de la CDMX con datos de la PGJ de la Ciudad de México.") +
  tema +
  theme(legend.position = "none", 
        panel.grid.major = element_blank(),
        axis.text.x = element_blank())
```

\newpage 

Las siguientes dos gráficas muestran el número acumulado de carpetas de investigación por `r datos_delito %>% summarise(delito = str_to_lower(last(categoria_de_delito)))`, en cada alcaldía durante todo el período analizado. La primera gráfica presenta las cifras en números absolutos y la segunda como tasa por cada 100 mil habitantes.^[Las tasas fueron calculadas usando estimaciones de CONAPO para 2017, reportadas por el INEGI y la CDMX en el [Anuario estadístico y geográfico de la Ciudad de México 2017](https://bit.ly/2Oya7eh).]


```{r prep_datos_carpetas_por_alcaldia, echo = F, cache = T, echo = F, warning = F, message = F}
datos_carpetas_por_alcaldia <- 
  datos_delito %>%
  group_by(alcaldia) %>% 
  summarise(num_carpetas = n()) %>% 
  ungroup() %>%  
  left_join(datos_poblacion_alcaldias, by = "alcaldia") %>% 
  mutate(tasa_x_100k = (num_carpetas/pob_total)*1e5,
         rank_absoluto = rank(-num_carpetas, ties.method = "first"),
         rank_tasa = rank(-tasa_x_100k, ties.method = "first"),
         etiqueta_carpetas_grande = ifelse(num_carpetas > 5, comma(num_carpetas), ""),
         etiqueta_carpetas_pequenio = ifelse(num_carpetas >= 0 & num_carpetas <= 5, comma(num_carpetas), ""),
         etiqueta_tasas_grande = ifelse(tasa_x_100k > 5, round(tasa_x_100k, 1), ""),
         etiqueta_tasas_pequenio = ifelse(tasa_x_100k >= 0 & tasa_x_100k < 5, round(tasa_x_100k, 1), ""))
  
  
top_3_absolutos_carpetas_alcaldia <- 
  datos_carpetas_por_alcaldia %>% 
  arrange(rank_absoluto) %>% 
  select(-rank_tasa) %>%  
  top_n(-3, wt = rank_absoluto) %>% 
  select(alcaldia)

top_3_absolutos_num_carpetas <- 
  datos_carpetas_por_alcaldia %>% 
  arrange(rank_absoluto) %>% 
  select(-rank_tasa) %>%  
  top_n(-3, wt = rank_absoluto) %>% 
  select(num_carpetas) %>% 
  mutate(num_carpetas_texto = str_c("**", comma(num_carpetas), "**", sep = ""))

top_3_tasa_carpetas_alcaldia <- 
  datos_carpetas_por_alcaldia %>% 
  arrange(rank_tasa) %>% 
  select(-rank_absoluto) %>%  
  top_n(-3, wt = rank_tasa) %>% 
  select(alcaldia)

top_3_tasa_num_carpetas <- 
  datos_carpetas_por_alcaldia %>% 
  arrange(rank_tasa) %>% 
  select(-rank_absoluto) %>%  
  top_n(-3, wt = rank_tasa) %>% 
  select(tasa_x_100k) %>% 
  mutate(tasa_x_100k = str_c("**", round(tasa_x_100k, 1), "**", sep = ""))
```

\vspace{2 mm}

```{r g_numero_total_carpetas_por_alcaldia, echo = F, dpi = 200, warning = F}
datos_carpetas_por_alcaldia %>% 
  ggplot(aes(fct_reorder(alcaldia, num_carpetas), num_carpetas)) +
  geom_col(fill = "#a50300", alpha = 0.9) +
  geom_text(aes(label = etiqueta_carpetas_grande), hjust = 1.2, color = "white", fontface = "bold", size = 3) +
  geom_text(aes(label = etiqueta_carpetas_pequenio), hjust = -0.8, color = "grey40", fontface = "bold", size = 3) +
  coord_flip() +
  labs(title = str_wrap(str_to_upper(str_c("número de carpetas de investigación por ", unique(datos_delito$categoria_de_delito), ", por alcaldia", paste = "")), width = 50),
       subtitle = str_wrap("Carpetas de investigación acumuladas entre el 1 enero de 2016 y el 31 de marzo de 2019", width = 90),
       x = NULL,
       y = "Número de carpetas",
       caption = str_wrap("\nFuente: Agencia Digital de Innovación Pública de la CDMX con datos de la PGJ de la Ciudad de México ", width = 130)) +
  tema +
  theme(axis.text.x = element_blank(),
        panel.grid.major = element_blank())

```

\vspace{2 mm}

En términos absolutos, `r stri_replace_last(str_c(top_3_absolutos_carpetas_alcaldia$alcaldia, collapse = ", "), replacement = " y", regex = ",")` son las tres alcaldías con el mayor número de carpetas de investigación por `r datos_delito %>% summarise(delito = str_to_lower(last(categoria_de_delito)))` iniciadas entre el 1 de enero de 2016 y el 31 de marzo de 2019 (`r stri_replace_last(str_c(top_3_absolutos_num_carpetas$num_carpetas_texto, collapse = ", "), replacement = " y", regex = ",")`, respectivamente). En conjunto, estas tres alcaldías concentran el **`r top_3_absolutos_num_carpetas %>% summarise(por = round(sum(num_carpetas)/sum(datos_carpetas_por_alcaldia$num_carpetas)*100, 1))`%** de todas las carpetas iniciadas por este delito en la Ciudad de México en el período analizado.

Al considerar el tamaño de la población de cada alcaldía, las tres con la mayor tasa de carpetas de investigación por cada 100 mil habitantes durante los poco más de tres años analizados son `r stri_replace_last(str_c(top_3_tasa_carpetas_alcaldia$alcaldia, collapse = ", "), replacement = " y", regex = ",")`, con tasas de `r stri_replace_last(str_c(top_3_tasa_num_carpetas$tasa_x_100k, collapse = ", "), replacement = " y", regex = ",")`, respectivamente. 

\vspace{2 mm}

```{r g_tasa_numero_total_carpetas_por_alcaldia, echo = F, dpi = 200, warning = F}
datos_carpetas_por_alcaldia %>% 
  ggplot(aes(fct_reorder(alcaldia, tasa_x_100k), tasa_x_100k)) +
  geom_col(fill = "#a50300", alpha = 0.9) +
  geom_text(aes(label = etiqueta_tasas_grande), hjust = 1.2, color = "white", fontface = "bold", size = 3) +
  geom_text(aes(label = etiqueta_tasas_pequenio), hjust = -0.7, color = "grey40", fontface = "bold", size = 3) +
  coord_flip() +
  labs(title = str_wrap(str_to_upper(str_c("tasa de carpetas de investigación por cada 100 mil habitantes por ", unique(datos_delito$categoria_de_delito), ", por alcaldia", paste = "")), width = 50),
       subtitle = str_wrap("Carpetas de investigación acumuladas entre el 1 enero de 2016 y el 31 de marzo de 2019", width = 90),
       x = NULL,
       y = "Tasa de carpetas por\ncada 100 mil habitantes",
       caption = str_wrap("\nFuente: Agencia Digital de Innovación Pública de la CDMX con datos de la PGJ de la Ciudad de México y el Anuario estadístico y geográfico de la Ciudad de México 2017 del INEGI y la CDMX.", width = 130)) +
  tema +
  theme(axis.text.x = element_blank(),
        panel.grid.major = element_blank())

```





\newpage 

# Distribución geográfica - Colonias

```{r prep_datos_ranking_colonias, echo = F, cache = T, echo = F, warning = F, message = F}
# Ranking de colonias con el mayor número de capretas de investigación por delito 
top_20_colonias_por_delito <- 
  datos_delito %>%
  filter(!is.na(colonia)) %>% # Eliminar observaciones que no incluyen colonia  
  group_by(categoria_de_delito, colonia, alcaldia) %>% # Agrupo por colonia y alcaldía porque existen colonias con el mismo nombre en diferentes alcaldías
  summarise(num_carpetas = n()) %>% 
  ungroup() %>% 
  group_by(categoria_de_delito) %>% 
  mutate(ranking_colonias = rank(-num_carpetas, ties.method = "first")) %>% 
  ungroup() %>% 
  arrange(categoria_de_delito, ranking_colonias) %>% 
  group_by(categoria_de_delito) %>% 
  mutate(num_acumulado_carpetas = cumsum(num_carpetas), 
         num_total_carpetas = sum(num_carpetas),
         por_acumulado_carpetas = (num_acumulado_carpetas/num_total_carpetas)*100) %>% 
  ungroup() %>% 
  mutate(col_del = paste(str_to_title(colonia), alcaldia, sep = " - ")) %>% 
  filter(ranking_colonias <= 20)

top_1_alcaldia_colonia <- 
  top_20_colonias_por_delito %>% 
  count(alcaldia, sort = T) %>%
  mutate(ranking = rank(-n, ties.method = "first")) %>%  
  filter(ranking == 1)

top_2_alcaldia_colonia <- 
  top_20_colonias_por_delito %>% 
  count(alcaldia, sort = T) %>%
  mutate(ranking = rank(-n, ties.method = "first")) %>%  
  filter(ranking == 2)

top_3_colonias_por_delito <- 
  top_20_colonias_por_delito %>% 
  top_n(3, wt = num_carpetas) %>% 
  mutate(num_carpetas_texto = str_c("**", comma(num_carpetas), "**", sep = ""))
```

La siguiente gráfica muestra el número de carpetas de investigación iniciadas por `r datos_delito %>% summarise(delito = str_to_lower(last(categoria_de_delito)))`, en las 20 colonias con el mayor número de denuncias por este delito. 

\vspace{2 mm}

```{r g_top_20_colonias_por_delito, echo = F, dpi = 200, warning = F, fig.height = 10}
top_20_colonias_por_delito %>% 
  ggplot(aes(fct_reorder(str_wrap(col_del, width = 35), num_carpetas), num_carpetas)) +
    geom_col(fill = "#a50300", alpha = 0.9) +
    geom_text(aes(label = comma(num_carpetas)), color = "white", hjust = 1.5, fontface = "bold", size = 4) +
    scale_y_continuous(expand = c(0, 0), labels = comma) +
    labs(title = str_wrap(str_to_upper(paste("las 20 colonias con el mayor número de carpetas de investigación por ", unique(top_20_colonias_por_delito$categoria_de_delito), sep = "")), width = 48),
         subtitle = str_wrap(paste("Estas 20 colonias concentran el ", round(max(top_20_colonias_por_delito$por_acumulado_carpetas), 1), "% (", comma(max(top_20_colonias_por_delito$num_acumulado_carpetas)), ") de las ", comma(max(top_20_colonias_por_delito$num_total_carpetas)), " carpetas de investigación iniciadas por este delito entre el 1 de enero de 2016 y el 31 de marzo de 2019"  , sep = ""), width = 80), 
         x = NULL,
         y = NULL, 
         caption = str_wrap("Fuente: Agencia Digital de Innovación Pública de la CDMX con datos de la PGJ de la Ciudad de México", width = 120)) +
    coord_flip() +
    tema +
    theme(panel.grid.major = element_blank(),
          axis.text.x = element_blank(),
          axis.text.y = element_text(size = 10))
```

\newpage

En conjunto, estas 20 colonias concentran el `r top_20_colonias_por_delito %>% summarise(round(max(por_acumulado_carpetas), 1))`%  de todas las carpetas iniciadas por este delito en la Ciudad de México durante los poco más de tres años analizados (`r top_20_colonias_por_delito %>% summarise(comma(max(num_acumulado_carpetas)))` de `r top_20_colonias_por_delito %>% summarise(comma(mean(num_total_carpetas)))`). De estas 20 colonias, `r top_1_alcaldia_colonia$n` se ubican en `r top_1_alcaldia_colonia$alcaldia`, y `r top_2_alcaldia_colonia$n`  más están en `r top_2_alcaldia_colonia$alcaldia`.

La lista la encabezan las colonias `r stri_replace_last(str_c(str_to_title(top_3_colonias_por_delito$colonia), collapse = ", "), replacement = " y", regex = ",")`, con  `r stri_replace_last(str_c(top_3_colonias_por_delito$num_carpetas_texto, collapse = ", "), replacement = " y", regex = ",")` carpetas en total, respectivamente. 

El siguiente mapa ofrece una perspectiva complementaria sobre la distribución geográfica de este delito en las más de 2,300 colonias de la CDMX.^[La base de datos de carpetas de investigación no incluye un identificador único para cada colonia. Esto impide unir los datos agregados a nivel colonia con su correspondiente polígono en el archivo de forma (*shape file*) de colonias. Asimismo, los nombres de las colonias incluidos en la base de datos de carpetas de investigación no coinciden en todos los casos con los nombres de las colonias en el archivo de forma. Esto dos problemas impiden contar el número de carpetas por colonia en la base de datos de carpetas de investigación, para después unir los datos al polígono correspondiente del archivo de forma. Dadas estas limitantes, optamos por medir la frecuencia del número de carpetas de investigación a través de contar el número de puntos que caen en cada polígono. Esta es una solución imperfecta y puede provocar que las cifras asignadas a una o más colonias varíen ligeramente del número real.  Otro motivo por el cuál pueden varias las cifras es porque no todos los registros de la base de datos de carpetas de investigación incluyen coordenadas de latitud y/o longitud. El análisis que aquí se presenta elimina los registros que no incluyen una o ambas coordenadas.] La intensidad del rojo de cada colonia es proporcional al número de carpetas de investigación iniciadas por este delito entre el 1 de enero de 2016 y el 31 de marzo de 2019. 

```{r prep_datos_mapa_carpetas_colonias, echo = F, cache = T, echo = F, warning = F, message = F}
# Nota: La base de datos de carpetas de investigación no incluye un identificador único para cada colonia. Esto impide unir los datos agregados a nivel colonia con su correspondiente polígono en el archivo de forma (*shape file*) de colonias. 

# Asimismo, los nombres de las colonias incluidos en la base de datos de carpetas de investigación no coinciden en todos los casos con los nombres de las colonias en el archivo de forma. Esto dos problemas impiden contar el número de carpetas por colonia en la base de datos de carpetas de investigación, para después unir los datos al polígono correspondiente del archivo de forma. 

# Dadas estas limitantes, optamos por medir la frecuencia del número de carpetas de investigación a través de contar el número de puntos que caen en cada polígono. Esta es una solución imperfecta y puede provocar que las cifras asignadas a una o más colonias varíen ligeramente del número real. 

# Otro motivo por el cuál pueden varias las cifras es porque no todos los registros de la base de datos de carpetas de investigación incluyen coordenadas de latitud y/o longitud. El análisis que aquí se presenta elimina los registros que no incluyen una o ambas coordenadas.

foo <-
  datos_delito %>% 
    filter(!is.na(longitud),      # Eliminar observaciones para las que falta
           !is.na(latitud)) %>%   # el dato de latitud y/o longitud. 
    st_as_sf(coords = c("longitud", "latitud"), crs = 4326)
  
# Construir vector con TRUE/FALSE para determinar si puntos están dentro de polígonos o no
resultados_hd <- st_within(foo, colonias_sf, sparse = FALSE) # Código adaptado de https://stackoverflow.com/questions/45899768/r-cloropleth-of-the-data-points-that-fall-within-a-polygon-what-percentage-h   
  
# Generar data frame para después graficar
faa <- 
  colonias_sf %>%
  mutate(num_carpetas = apply(resultados_hd, 2, sum), # Contar número de puntos que caen dentro de cada colonia
         categoria_de_delito = unique(foo$categoria_de_delito),
         categoria_de_delito = str_trim(categoria_de_delito),
         cat_delito_mayusculas = str_to_upper(categoria_de_delito),
         cat_delito_archivo = str_replace_all(str_to_lower(categoria_de_delito), " ", "_"),
         titulo = paste("número de carpetas de investigación iniciadas por ", cat_delito_mayusculas, ", por colonia", sep = ""), 
         titulo = str_to_upper(titulo),
         titulo = str_squish(titulo)) 
```

\vspace{2 mm}

```{r mapa_carpetas_por_colonia, echo = F, dpi = 200, warning = F, fig.height = 7, message = F}
# Mapa
faa %>% 
  ggplot() +
  geom_sf(aes(fill = num_carpetas), color = "grey70", size = 0.2) +
  geom_sf(data = alcaldias_sf, color = "grey40", fill = NA, size = 0.3) +
  coord_sf(xlim = c(-99.5, -98.8), datum = NA) +
  scale_fill_gradient(low = "white", high = "#a50300", breaks = round(seq(0, max(faa$num_carpetas), max(faa$num_carpetas)/5), 0), limits = c(0, max(faa$num_carpetas)), labels = comma) +  
  labs(title = str_wrap(faa$titulo, width = 58),
       subtitle = "Datos de enero de 2016 al 31 de marzo de 2019",
       fill = "Núm. de carpetas\nde investigación",
       caption = "\nFuente: Agencia Digital de Innovación Pública de la CDMX con datos de la Procuraduría General de Justicia de la Ciudad de México") +
  tema +
  theme(panel.grid.major=element_line(colour = "transparent"),
        axis.text = element_blank(),
        axis.title = element_blank(),
        legend.position = c(0.15, 0.6),
        legend.title = element_text(face = "bold", size = 13),
        legend.text = element_text(face = "bold", size = 11),
        legend.key.height = unit(1.5, "cm"))
```


 